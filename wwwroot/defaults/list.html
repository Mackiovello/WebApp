<link rel="import" href="/sys/polymer/polymer.html">
<link rel="import" href="/sys/puppet-redirect/puppet-redirect.html"/>
<link rel="import" href="/sys/paper-alert-dialog/paper-alert-dialog.html" />

<template>
    <template is="dom-bind">
        <h3>{{model.ResourceName}}</h3>

        <template is="dom-if" if="{{model.HasMessage}}">
            <paper-alert-dialog title="{{model.MessageType}}"
                                confirm-button="OK"
                                opened="true">
                {{model.Message}} (Error code {{model.ErrorCode}})
            </paper-alert-dialog>
        </template>

        <template is="dom-if" if="{{model.CanInsert}}">
            <div>
                <button class="btn btn-sm btn-primary" value="{{model.Add$::click}}" on onmouseup="++this.value">Add</button>
            </div>
        </template>
        <table class="table">
            <thead>
            <tr>
                <template is="dom-repeat" items="{{model.TableHead}}">
                    <th>{{item}}</th>
                </template>
            </tr>
            </thead>

            <tbody>
            <template is="dom-repeat" items="{{model.Entities}}" as="row">
                <tr>
                    <template is="dom-repeat" items="{{model.TableHead}}" as="name">
                        <template is="dom-if" if="{{unique(name, model.UniqueIdentifiers)}}">
                            <td>
                                <a href="{{model.ResourcePath}}/{{name}}={{byname(row,name)}}">{{byname(row,name)}}</a>
                            </td>
                        </template>
                        <template is="dom-if" if="{{!unique(name, model.UniqueIdentifiers)}}">
                            <td>{{byname(row,name)}}</td>
                        </template>
                    </template>
                </tr>
            </template>
            </tbody>
        </table>

        <link is="puppet-redirect" history url$="{{model.RedirectUrl$}}"/>
    </template>
    <script>
        (function () {
            const script = document._currentScript || document.currentScript;
            const template = script.previousElementSibling;

            template.byname = (obj, name) => {
                const val = obj[name + "$"];
                if (Array.isArray(val))
                    return val.join(", ");
                return val;
            }
            template.unique = (name, uids) => uids.indexOf(name) > -1;

            template.members = obj => Object.keys(obj).map(key => ({
                name: key.slice(0, -1),
                value: obj[key]
            }));
        })();
    </script>
</template>